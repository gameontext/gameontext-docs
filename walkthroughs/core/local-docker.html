<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><link rel=stylesheet href=https://use.fontawesome.com/e3112f1bdf.css><link rel=stylesheet href=/css/flex.min.cb8b8d13f41f6429f128017210f5e73b9c0e95415c7315a71fca50bcb62b3580.css><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><title>GO: Running with Docker Compose</title><link rel=canonical href=/walkthroughs/core/local-docker.html><link rel=alternate type=application/rss+xml href=/blog/index.xml title="Game On! Adventures with microservices"></head><body><header class=head-single><h1><a href=/>GAME<span class=on>ON</span></a></h1><div>Hands-on experiment building microservices and cloud native applications</div></header><nav class=project><a target=_blank href=https://gameontext.org title="Play the game"><i class="fa fa-play" aria-hidden=true></i><span>Play <span>the game</span></span></a>
<a href=/about/ title="Read the book"><i class="fa fa-book" aria-hidden=true></i><span>Learn <span>more</span></span></a>
<a href=/blog/ title="Read the blog"><i class="fa fa-newspaper-o" aria-hidden=true></i><span>Read <span>our blog</span></span></a>
<a target=_blank href=https://gameontext.org/slackin/ title="Join our slack team"><i class="fa fa-slack" aria-hidden=true></i><span><span>Join us on</span> Slack</span></a>
<a target=_blank class=github href=https://github.com/gameontext title="View project on GitHub"><i class="fa fa-github" aria-hidden=true></i><span>Github</span></a></nav><main class="book page"><article><header><h1>Running with Docker Compose</h1></header><nav id=toc class=toc role=doc-toc><h2 id=toc-title></h2><ol class="toc-list level-1"><li><a href=#_requirements>Requirements</a></li><li><a href=#running>Starting game services locally</a></li><li><a href=#_files_supporting_docker_compose>Files supporting Docker Compose</a></li><li><a href=#_configuration>Configuration</a></li><li><a href=#_ssh_keys_and_keystores>SSH Keys and KeyStores</a></li><li><a href=#rebuild>Rebuilding Core Game services with Docker Compose</a><ol class="toc-list level-2"><li><a href=#_iterative_development_of_java_applications_with_wdt>Iterative development of Java applications with WDT</a></li><li><a href=#dockerhost>Determining the host IP address (Docker Toolbox)</a></li></ol></li></ol></nav><section class="doc-section level-1"><h2 id=_requirements>Requirements</h2><div class=ulist><ul><li><code>docker-compose</code> <a href=https://github.com/docker/compose/releases>version 1.15.0 or greater</a>.
<a href=https://docs.docker.com/compose/install/>Installation instructions</a> vary by platform.</li></ul></div></section><section class="doc-section level-1"><h2 id=running>Starting game services locally</h2><div class="olist arabic"><ol class=arabic><li>Obtain the source for the root project (<a href=https://github.com/gameontext/gameon>gameontext/gameon</a>)<ul><li>HTTPS: <code>git clone <a class=bare href=https://github.com/gameontext/gameon.git>https://github.com/gameontext/gameon.git</a></code></li><li>SSH: <code>git clone <a href=mailto:git@github.com>git@github.com</a>:gameontext/gameon.git</code></li></ul></li><li><p>Change to the gameon directory</p><div class=listing-block><pre>$ cd gameon</pre></div></li><li><p>Setup your environment (one time, see <a href=#go-run>below</a>).</p><div class=listing-block><pre>$ ./go-admin.sh choose       # choose Docker Compose
$ eval $(./go-admin.sh env)  # set script aliases
$ alias go-run               # confirm `docker/go-run.sh`</pre></div></li><li><p>Set up core game services (repeatable):</p><div class=listing-block><pre>$ go-run setup</pre></div><p>This will ensure that you have an env file suitable for use
with <code>docker-compose</code> and pulls the initial images required
for running the system.</p><p>When using Vagrant, this step is done as part of provisioning the VM.</p></li><li><p>Start core game services:</p><div class=listing-block><pre>$ go-run up</pre></div></li><li><p>Wait for the system warm up</p><div class=listing-block><pre>$ go-run wait</pre></div><p>or, to watch the logs stream by, try:</p><div class=listing-block><pre>$ go-run logs</pre></div></li><li><strong>Carry on with <a href=/walkthroughs/advanced/>building your room</a>!</strong></li><li><p>Clean up</p><div class=listing-block><pre>$ go-run down</pre></div></li></ol></div></section><section class="doc-section level-1"><h2 id=_files_supporting_docker_compose>Files supporting Docker Compose</h2><p>The <code>docker</code> subdirectory of the root project
contains the files required to make game services go:</p><div class=ulist><ul><li><code>docker-compose.yml</code> declares core game and required backing services</li><li><code>docker-compose.override.yml.example</code> can be copied to <code>docker-compose.override.yml</code>
and modified to support overlays for local development</li><li><code>go-run.sh</code> helps with starting, stopping, and cleaning up Game On! core services.</li><li><code>docker-functions</code> is used by <code>go-run.sh</code> to generate the keystore volume
and perform docker-specific, environment-appropriate commands.</li></ul></div></section><section class="doc-section level-1"><h2 id=_configuration>Configuration</h2><p>When Game On! runs in the cloud, it uses etcd to obtain its configuration.
When running locally it expects all this to be fed to it via the environment.
The <code>gameon.env</code> file defined in the docker directory provides this local
configuration for Docker Compose.</p><p>Some additional notes regarding environment-specific config:</p><div class=ulist><ul><li>When you run natively, the "host" for your containers is the OS itself, so
127.0.0.1 will work just fine (default url in <code>gameon.env</code>).</li><li>When you run in Docker Toolbox, there is a VirtualMachine acting as the host
for your containers. This means that (for URLs and other things) you need to
use the <a href=#dockerhost>IP of the VM</a>. A <code>gameon.&lt;DOCKER_MACHINE_NAME>env</code>
file will be created as a modified copy of <code>gameon.env</code> to adjust.</li><li>Similarly, if you are running with Vagrant, you need to use the Vagrant VM&#8217;s
IP address. A <code>gameon.vagrantenv</code> file will be created in the docker directory
as a modified copy of <code>gameon.env</code>.</li></ul></div></section><section class="doc-section level-1"><h2 id=_ssh_keys_and_keystores>SSH Keys and KeyStores</h2><p>Because Game On! uses a Certificate for HTTPS and for JWT signing, we need to
generate one for local use. We create a special mapped volume (called <code>keystore</code>)
that provides a generated local keystore to containers.</p><p>Scripts will ensure that this volume exists.</p><aside class="admonition-block note" id=go-run role=note><h6 class=block-title><span class=title-label>Note: </span>About <code>go-run.sh</code>, <code>go-run</code>, and <code>go-compose</code>:</h6><div class=ulist><ul><li><p>Use <code>eval $(./docker/go-run.sh env)</code> to add <code>go-run</code> and <code>go-compose</code> aliases
to your shell:</p><div class=listing-block><pre>$ eval $(./docker/go-run.sh env)
$ alias</pre></div></li><li><p>Use <code>go-run</code> without arguments to get a list of available actions. Some examples
based on the alias created above:</p><div class=listing-block><pre>$ go-run up
$ go-run down
$ go-run logs
$ go-run rebuild
$ go-run restart
$ go-run wait</pre></div></li><li><p><code>go-compose</code> wraps the invocation of <code>docker-compose</code> with <code>-f</code> options for
<code>docker-compose.yml</code> and <code>docker-compose.override.yml</code> (if present), and
<code>sudo</code> (if required).</p><div class=listing-block><pre>$ go-compose ps
$ go-compose logs</pre></div></li></ul></div></aside><p>Additional notes when running with Docker Compose:</p><div class=ulist><ul><li><code>docker-compose</code> still requires sudo on linux platforms, even
though <code>docker</code> doesn&#8217;t.</li><li>The Vagrant VM allows all <code>sudo</code> operations with no password.</li></ul></div></section><section class="doc-section level-1"><h2 id=rebuild>Rebuilding Core Game services with Docker Compose</h2><p>The following instructions assume you&#8217;ve cloned the root repository,
and are interested in editing the <code>map</code> service as an example:</p><div class="olist arabic"><ol class=arabic><li><p>Change to the gameon directory</p><div class=listing-block><pre>$ cd gameon</pre></div></li><li><p>Obtain the source for the project that you want to change.</p><div class=listing-block><pre>$ git submodule init map
$ git submodule update map</pre></div></li><li><p>Make your changes from within the child directory</p><div class=listing-block><pre>$ cd map
$ git checkout -b newbranch</pre></div><p>Edit source or docker/image files using your favorite IDE.</p><aside class="admonition-block tip" role=doc-tip><h6 class="block-title label-only"><span class=title-label>Tip:</span></h6><p>If you plan to edit projects with Eclipse, run <code>./bin/eclipse.sh</code> to generate eclipse project files.</p></aside></li><li>Compile the source and rebuild docker image<ul><li><p>To rebuild and restart the map service:</p><div class=listing-block><pre>$ go-run rebuild map</pre></div></li><li><p>To rebuild the image without recreating the container:</p><div class=listing-block><pre>$ go-run rebuild_only map</pre></div></li><li><p>If the service argument is left off, it will attempt to rebuild all
of the core services (auth, map, mediator, player, room, webapp). If those
submodules haven&#8217;t been checked out, there is no harm. The image from dockerhub
will be used instead.</p><aside class="admonition-block note" role=note><h6 class=block-title><span class=title-label>Note: </span>Top-down vs. incremental updates</h6><p>If you want to try using incremental publish, where your changes are live inside
the container without requiring the container to be stopped, started, rebuilt
or otherwise messed with, you&#8217;ll need to create and/or add some lines
to <code>./docker/docker-compose.override.yml</code> to create overlay volumes.</p><p><code>./docker/docker-compose.override.yml.example</code> provides examples of how
to map expected github subrepository paths to volumes. Copy snippets from
that file for the services you&#8217;re interested in into <code>docker-compose.override.yml</code>.</p><p><code>./docker/go-run.sh</code> will accommodate the creation of the <code>docker-compose.override.yml</code>
file, but you may need to run <code>eval $(./docker/go-run.sh env)</code> to update your
aliases.</p></aside></li></ul></li><li><p>Push your changes to a new branch. From the map directory:</p><div class=listing-block><pre>$ git add -u
$ git commit -s</pre></div></li></ol></div><div class=example-block><div class=example><p>Git commits must be <a href=https://github.com/gameontext/gameon/blob/master/CONTRIBUTING.md>signed</a></p></div></div><p>Once you make your commit, if you go back to the root directory, you will see
a pending change for map. This indicates that the submodule is different than
the version from the current branch of the root project.</p><p><strong>Do not check in changes to submodule versions</strong></p><p>+
Care must be taken to avoid staging these files if you otherwise end up making
changes to files in the root project itself.</p><section class="doc-section level-2"><h3 id=_iterative_development_of_java_applications_with_wdt>Iterative development of Java applications with WDT</h3><p>If you&#8217;re using Eclipse for development, and have opted for the iterative
approach (using <code>docker-compose.override.yml</code> for volumes, e.g.),
we recommend using WebSphere Developer Tools (WDT) to work with the Java
services contained in the sample. There is some (one time) <a href=/walkthroughs/eclipse-and-wdt.html>configuration
required to make WDT happy with the docker-hosted applications</a>,
but you are then free to use eclipse to make changes to the project that will
be immediately picked up by the running server without having to rebuild
or restart anything.</p></section><section class="doc-section level-2"><h3 id=dockerhost>Determining the host IP address (Docker Toolbox)</h3><p>After you have Docker Toolbox installed, verify the host machine name:
<code>docker-machine ls</code>. The default name is <code>default</code>, but if you&#8217;re a former
Boot2Docker user, it may be <code>dev</code> instead. Substitute this value appropriately
in what follows.</p><p>If you aren&#8217;t using the docker quick-start terminal, you&#8217;ll need to set the
docker environment variables in your command shell using
<code>eval "$(docker-machine env default)"</code>.</p><p>Get the IP address for your host using <code>docker-machine ip default</code>.</p><p><code>./docker/go-setup.sh</code> and <code>./docker/go-run.sh</code> will create a
<code>gameon.&lt;DOCKER_MACHINE_NAME>env</code> file to account for the IP address
difference.</p></section></section></article><nav class=prev-next><div class=nav-left><div class=long><a href=/walkthroughs/core/git.html title="Previous: Git">Git</a></div><div class=short><a href=/walkthroughs/core/git.html title="Previous: Git">Previous</a></div></div><div class=nav-center><div class=long>Up: <a href=/walkthroughs/core/>Running core services locally</a></div><div class=short><a href=/walkthroughs/core/>Up</a></div></div><div class=nav-right><div class=long><a href=/walkthroughs/core/local-kubernetes.html title="Next: Running with Kubernetes">Running with Kubernetes</a></div><div class=short><a href=/walkthroughs/core/local-kubernetes.html title="Next: Running with Kubernetes">Next</a></div></div></nav></main><footer class=foot><div id=copyrights>&#169; 2016-2020 under terms of the Apache License 2.0.</div><div>Follow us:
<a target=_blank href=https://twitter.com/gameontext title="Follow @gameontext"><i class="fa fa-twitter" aria-hidden=true></i></a></div></footer><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-90113653-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>