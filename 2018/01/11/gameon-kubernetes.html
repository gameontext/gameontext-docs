<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><link rel=stylesheet href=https://use.fontawesome.com/e3112f1bdf.css><link rel=stylesheet href=/css/flex.min.91ae1aeed7badce87595f5907a69c5f2dd2ec5c30b14acc1ac7dc06c478cb95b.css><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><title>GO: Moving GameOn to Kubernetes</title><link rel=canonical href=/2018/01/11/gameon-kubernetes.html><link rel=alternate type=application/rss+xml href=/blog/index.xml title="Game On! Adventures with microservices"></head><body><header class=head-single><h1><a href=/>GAME<span class=on>ON</span></a></h1><div>Hands-on experiment building microservices and cloud native applications</div></header><nav class=project><a target=_blank href=https://gameontext.org title="Play the game"><i class="fa fa-play" aria-hidden=true></i><span>Play <span>the game</span></span></a>
<a href=/about/ title="Read the book"><i class="fa fa-book" aria-hidden=true></i><span>Learn <span>more</span></span></a>
<a href=/blog/ title="Read the blog"><i class="fa fa-newspaper-o" aria-hidden=true></i><span>Read <span>our blog</span></span></a>
<a target=_blank href=https://gameontext.org/slackin/ title="Join our slack team"><i class="fa fa-slack" aria-hidden=true></i><span><span>Join us on</span> Slack</span></a>
<a target=_blank class=github href=https://github.com/gameontext title="View project on GitHub"><i class="fa fa-github" aria-hidden=true></i><span>Github</span></a></nav><article class=post><header><h1>Moving GameOn to Kubernetes</h1><div class=byline><div><time class=post_date>11 January 2018</time> by<address class=author><a rel=author target=_blank href=https://github.com/BarDweller>ozzy</a></address></div><div class=tags>tags:<ul><li><a href=/tags/java>java</a></li><li><a href=/tags/kubernetes>kubernetes</a></li><li><a href=/tags/local>local</a></li></ul></div></div></header><section class=content><h2 id=game-on-and-kubernetes>Game On! and Kubernetes</h2><p>Here at Game On! central, we've been considering how to run on Kubernetes for quite some time, and during a pause in the recent Holiday Season, we had a chance to add Kubernetes support allowing you to run the core services locally.</p><p>This work partly builds on an earlier attempt to bring Game On! to Kubernetes back in May last year. We learnt a few lessons from that attempt, and like to think this
attempt is a little cleaner.</p><div class=flex-media><div class=item><a href=#419a912fb80cc67f03c75cd10f9614bf class=thumbnail><img src=/files/2018-gokube/gokube.png title="Game On! running on Kubernetes"></a>
<a href=#_ id=419a912fb80cc67f03c75cd10f9614bf class=lightbox><img src=/files/2018-gokube/gokube.png title="Game On! running on Kubernetes"></a></div></div><h2 id=running-game-on-in-kubernetes>Running Game On! in Kubernetes</h2><p>Want to try it out? we've tested on <a href=https://github.com/kubernetes/minikube>minikube</a>, and <a href=https://github.com/IBM/deploy-ibm-cloud-private>IBM Cloud Private (ICP)</a>.</p><p>It's as simple as;</p><ul><li>Setup your minikube/icp, and have <a href=https://kubernetes.io/docs/tasks/tools/install-kubectl/>kubectl</a> installed locally, and configured to talk to your cluster.<ul><li>For minikube, you'll need to enable ingress with <code>minikube addons enable ingress</code></li><li>For ICP, this means you must execute the &lsquo;<a href=https://github.com/IBM/deploy-ibm-cloud-private/blob/master/README.md>configure client</a>&rsquo; steps to authenticate to the cluster</li></ul></li><li>Clone the <a href=https://github.com/gameontext/gameon>gameon root repository</a><ul><li><code>git clone https://github.com/gameontext/gameon.git</code></li></ul></li><li><code>cd</code> to the cloned project, then into the <code>kubernetes</code> directory<ul><li><code>cd gameon/kubernetes</code></li></ul></li><li>set the environment variable <code>GAMEON_HOST</code> to the ip of your kubernetes cluster, if you are using minikube, this is probably 192.168.99.100, if you are using ICP via Vagrant, it will default to 192.168.27.100 (unless you altered the network in the Vagrantfile)<ul><li><code>export GAMEON_HOST=192.168.99.100</code></li></ul></li><li>run <code>./go-run.sh up</code> this will do the following for you..<ul><li>create the kubernetes namespace <code>gameon-system</code></li><li>edit <code>ingress.yaml</code> and <code>gameon-configmap.yaml</code> to insert your cluster ip as appropriate.</li><li>create a new self signed certificate/keypair, and load it into a kubernetes config map</li><li>create the ingress, config map, couchdb, kafka, auth, mediator, map, player, and webapp deployments and services in kubernetes.</li></ul></li></ul><p>To check on progress, you can check the cluster gui, or use kubectl to check on the status of the pods in the <code>gameon-system</code> namespace. ( <code>kubectl get pods --namespace=gameon-system -o wide</code>)</p><p>After a short while, once the the pods are all up and running, you should be able to access your Game On! at <code>https://gameon.192.168.99.100.xip.io</code></p><p>Swap <code>192.168.99.100</code> for your cluster ip, the same value you set in <code>GAMEON_HOST</code></p><p>If you want to remove Game On! from your cluster, run <code>./go-run.sh down</code> and the script will remove the artifacts it created.</p><h2 id=whats-actually-happening-here>Whats actually happening here?</h2><p>Each of the core services has their own yaml, that contains both a kubernetes <a href=https://kubernetes.io/docs/concepts/services-networking/service/>service</a>, and a <a href=https://kubernetes.io/docs/concepts/workloads/controllers/deployment/>deployment</a>. The deployment defines a <a href=https://kubernetes.io/docs/concepts/workloads/controllers/replicaset/>replica set</a> that will deploy the appropriate Game On! image in a pod, with the appropriate environment variables set with values from the <a href=https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/>config map</a> defined by <code>gameon-configmap.yaml</code>. The certificate used by the core services to sign and validate JWTs is mapped into each container <a href=https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/#populate-a-volume-with-data-stored-in-a-configmap>as a file</a>, where the startup scripts are able to convert it into the keystore/truststore that are required by the Java pods.</p><p>The <code>ingress.yaml</code> defines a <a href=https://kubernetes.io/docs/concepts/services-networking/ingress/>kubernetes ingress</a> that acts as the front door for the whole setup, routing requests to the appropriate service. Requets are mapped using the path part of the URL just as happens in the <code>proxy</code> service when running outside of Kubernetes. <code>ingress.yaml</code> also defines and enables HTTPS for the front door, and if we wanted, we could <a href=https://kubernetes.io/docs/concepts/services-networking/ingress/#tls>configure a certificate</a> to be used for HTTPS in the yaml here.</p><p>Lastly, we're using <a href=http://xip.io/>xip.io</a> which is a handy service that allows you to create hostnames that map to ip addresses, without needing to edit <code>/etc/hosts</code> etc. Any url ending in <code>ipaddress.xip.io</code> resolves to <code>ipaddress</code>, so in our case <code>gameon.192.168.99.100.xip.io</code> will resolve to <code>192.168.99.100</code>, this is great, because ingress definitions require a hostname, not an ip address, and this lets us create one for testing, without any setup.</p><p><em>TIP:</em> <em>your router may be &ldquo;helpful&rdquo; and block dns resolution for ip addresses in private networks, such as 192.168.x.x or 10.x.x.x, if so, look in your router for if you can configure a Domain Whitelist for xip.io for RFC1918 responses. This is required at least for OpenWRT/LEDE. If you can't unblock that, you'll have to resort to editing /etc/hosts or equivalent for your platform.</em></p><h2 id=pods-of-fun>Pods of fun!</h2><p>Now it's running inside Kubernetes, in future, we'll be able to scale the number of services, for better availability, and to enable graduated rollouts of newer service versions.</p><p>For now, thanks to handy tools like the <a href=https://www.ibm.com/support/knowledgecenter/en/SSBS6K_2.1.0/featured_applications/deploy_monitoring.html>IBM Cloud Private monitoring service</a> we can look at say, how much ram each pod is using&mldr;</p><p>You can see similar, but less detailed information from minikube's dashboard, or install heapster with <code>minikube addons enable heapster</code></p><p>As becomes quite apparent from the charts, Kafka eats almost 5 times the memory of our average service! Why not have a dig around and see what you can find out!</p><div class=flex-media><div class=item><a href=#22ecc53976be9353a57471a03a2cdea0 class=thumbnail><img src=/files/2018-gokube/memperpodwithkafka.png></a>
<a href=#_ id=22ecc53976be9353a57471a03a2cdea0 class=lightbox><img src=/files/2018-gokube/memperpodwithkafka.png></a></div><div class=item><a href=#52c2c094a421a12d86c2f29905c323d0 class=thumbnail><img src=/files/2018-gokube/memperpodwithoutkafka.png></a>
<a href=#_ id=52c2c094a421a12d86c2f29905c323d0 class=lightbox><img src=/files/2018-gokube/memperpodwithoutkafka.png></a></div></div></section></article><nav class=prev-next><div class=nav-left><a href=/2017/11/02/climbing-inside-your-code.html title="Previous: Climbing inside your code: A unique look at the game">Previous</a></div><div class=nav-center><a href=/blog/>Blog</a> | <a href=/archive/>Archive</a></div><div class=nav-right><a href=/2018/10/02/kubernetes-status.html title="Next: Advanced KubecCtl">Next</a></div></nav><footer class=foot><div id=copyrights>&#169; 2016-2020 under terms of the Apache License 2.0.</div><div>Follow us:
<a target=_blank href=https://twitter.com/gameontext title="Follow @gameontext"><i class="fa fa-twitter" aria-hidden=true></i></a></div></footer><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-90113653-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>