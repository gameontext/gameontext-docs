<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><link rel=stylesheet href=https://use.fontawesome.com/e3112f1bdf.css><link rel=stylesheet href=/css/flex.min.bacceede6addae95ca0c59845a9c0349115c827a2c68e043fb9a1113f390d0c3.css><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><title>GO: Core services</title><link rel=canonical href=/architecture/core-services.html><link rel=alternate type=application/rss+xml href=/blog/index.xml title="Game On! Adventures with microservices"></head><body><header class=head-single><h1><a href=/>GAME<span class=on>ON</span></a></h1><div>Hands-on experiment building microservices and cloud native applications</div></header><nav class=project><a target=_blank href=https://gameontext.org title="Play the game"><i class="fa fa-play" aria-hidden=true></i><span>Play <span>the game</span></span></a>
<a href=/about/ title="Read the book"><i class="fa fa-book" aria-hidden=true></i><span>Learn <span>more</span></span></a>
<a href=/blog/ title="Read the blog"><i class="fa fa-newspaper-o" aria-hidden=true></i><span>Read <span>our blog</span></span></a>
<a target=_blank href=https://gameontext.org/slackin/ title="Join our slack team"><i class="fa fa-slack" aria-hidden=true></i><span><span>Join us on</span> Slack</span></a>
<a target=_blank class=github href=https://github.com/gameontext title="View project on GitHub"><i class="fa fa-github" aria-hidden=true></i><span>Github</span></a></nav><main class="book page"><article><header><h1>Core services</h1></header><p><img src=/images/CoreServices.jpeg alt="Core services"></p><section class="doc-section level-1"><h2 id=_auth>Auth</h2><p>Auth is a very small lightweight authentication system. It allows players to
connect and identify themselves via a selected "social login". We assume that
the client (JavaScript running on a device outside of our environment) is not
secure, so player authentication using OAuth is initiated by the Player service,
rather than by the client/webapp.</p><p>This service used to be part of the Player service, when we considered the Player
service to be looking after all things related to the Player. As the application
grew in scope, and we added additional social login providers, it started to become
clear that the Auth aspect of Player was deserving of it&#8217;s own service. This allowed
us to separate and better manage the various library dependencies of the Auth code
from the persistent store used by Player.</p><p>The Auth service hosts an endpoint per supported social login provider, and the
flow goes something like this: the user (that&#8217;s you), pushes a button in the
web UI to select an OAuth provider (Facebook, Google, GitHub, or Twitter). This
button press sends an async REST request to the Player to initiate the
authentication process. The Player sends a REST request to the selected OAuth
provider using the proper credentials. Many redirects later, we get a callback
from the OAuth provider letting us know that you authenticated properly. We then
<a href=application-security.html>sign a JWT</a>, which is passed back to the client/webapp.</p><p>Auth declares itself as an Amalgam8 service on startup, allowing it&#8217;s discovery by
other services, such as the Proxy/Gateway. Currently Auth makes its calls to the
social login services directly, but we plan to direct these calls through Amalgam8
to better enable testing, and simulate remote failures.</p></section><section class="doc-section level-1"><h2 id=_webapp>Webapp</h2><p>Webapp is a simple nginx process that serves the static files that comprise the
front-end of the UI. The front-end is a single page application written in
JavaScript that makes requests using standard/published APIs to interact with
backend microservices via the proxy/gateway.</p><p>Having this as a separate entity allows our front-end to be changed and updated
independently from other services. Some suggest that UI components should be
provided by each backend service, which can be true with a UI built from distinct
sections. The game, however, uses a more integrated UI, with much of the rendered
data coming from a long-lived <a href=websocket-protocol.html>WebSocket connection using a custom
protocol</a>.</p><p>The webapp process has fairly simple scaling requirements, as it serves cachable
static files. It is not (yet) an Amalgam8 service, but we plan to convert it into
one in our next integration pass.</p></section><section class="doc-section level-1"><h2 id=_player>Player</h2><p>Players are represented by the player service, which provides a
<a href=https://gameontext.org/swagger/>public API</a> for CRUD operations, and for managing API tokens.</p><p>The Player service was one of the first to exist, and is implemented in Java
using WebSphere Liberty. It stores data in either couchdb (local) or Cloudant.</p><p>The Player service registers as an Amalgam8 service on startup, enabling other
services to find it, and allowing for scaling via additional instances if required.</p></section><section class="doc-section level-1"><h2 id=_mediator>Mediator</h2><p>Once upon a time, the mediator was part of the player service. It was split into
its own microservice for two reasons: 1) the function it performs is not strictly
related to the notion of a "player", and 2) it has drastically different scaling
requirements.</p><p>After a user has logged in, a WebSocket is established between the user&#8217;s device
and the mediator. The mediator then maintains a second WebSocket connection to
whatever room the player is in. Maintaining two long-lived connections (even with
asynchronous processing going on) will use resources differently than other kinds
of REST or HTTP request processing.</p><p>To provide the best user experience it can, the mediator retains cached information
about rooms it has visited, to ensure that players can move between rooms if the
map service can&#8217;t be reached. It also provides a few special rooms itself (First
Room, Empty Room, and Sick Room) to provide a good user experience in the face
of badly behaved or failing rooms.</p><p>The Mediator service is implemented in Java using WebSphere Liberty, it does not
use an external data store. As noted above, its API is a <a href=websocket-protocol.html>WebSocket
endpoint with a custom protocol</a>.</p><p>Mediator also registers as an Amalgam8 service, enabling proxy to forward traffic
to it (including the WebSocket from the end user). Requests to Player and Map made
by Mediator are routed via the local in-container Amalgam8 proxy, allowing those
to scale as required.</p><section class="doc-section level-2"><h3 id=_first_room>First Room</h3><p>First Room is the starting place for every player joining the game, and is also
where players return when things go terribly wrong, or when they call for a rescue
(<code>/sos</code>). It also provides a few special commands that room implementors can use
to teleport to rooms that they own.</p></section><section class="doc-section level-2"><h3 id=_empty_room>Empty Room</h3><p>Empty rooms act as placeholders: they do nothing interesting, but are navigable
to allow players to navigate the map even when there are holes in it.</p></section><section class="doc-section level-2"><h3 id=_sick_room>Sick Room</h3><p>Sick rooms are also placeholders, but they specifically stand in for rooms that
exist, but are not responsive. They are a game-appropriate implementation of the
circuit breaker pattern: detecting failures and unresponsive rooms, and
preventing repeated access to those rooms until they have been restored.</p></section></section><section class="doc-section level-1"><h2 id=_map>Map</h2><p><a href=map.html>The Map</a> maintains a 2-dimensional grid containing all known (registered
and empty) rooms.</p><p>The Map service is a Java EE application running on WebSphere Liberty that
provides a <a href=https://gameontext.org/swagger/>public REST API</a> using JAX-RS. It stores
data in a NoSQL data store, either couchdb or Cloudant. Methods that modify the
map require <a href=application-security.html>signed requests</a>.</p><p>Map registers as an Amalgam8 service at startup, enabling Mediator and Proxy to
find it and place invocations to it via their in-container proxies.</p></section><section class="doc-section level-1"><h2 id=_sweep>Sweep</h2><p>The Sweep performs periodic rounds of all the registered rooms, checking to see
if they are still reachable, and that they behave properly according to the
documented <a href=websocket-protocol.html>WebSocket protocol</a>.</p></section><section class="doc-section level-1"><h2 id=_proxygateway>Proxy/Gateway</h2><p>We have a single proxy/gateway that is haproxy based, and is responsible
for surfacing the <a href=https://gameontext.org/swagger/>collection of APIs</a> as a single facade for
the entire application.</p><p>Today this proxy identifies services via url patterns, and where a request is
made to an Amalgam8 registered service, the proxy will place that invocation via
the Amalgam8 in-container proxy. This both provides Service Discovery, and Service
Proxying, allowing the instances of the servce being routed to to scale as required.</p></section></article><nav class=prev-next><div class=nav-left><div class=long><a href=/about/ title="Previous: Exploring Microservices — Game On!">Exploring Microservices — Game On!</a></div><div class=short><a href=/about/ title="Previous: Exploring Microservices — Game On!">Previous</a></div></div><div class=nav-center><div class=long>Up: <a href=/architecture/>Application Architecture</a></div><div class=short><a href=/architecture/>Up</a></div></div><div class=nav-right><div class=long><a href=/architecture/platform-services.html title="Next: Platform services">Platform services</a></div><div class=short><a href=/architecture/platform-services.html title="Next: Platform services">Next</a></div></div></nav></main><footer class=foot><div id=copyrights>&#169; 2016-2021 under terms of the Apache License 2.0.</div><div>Follow us:
<a target=_blank href=https://twitter.com/gameontext title="Follow @gameontext"><i class="fa fa-twitter" aria-hidden=true></i></a></div></footer><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-90113653-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>